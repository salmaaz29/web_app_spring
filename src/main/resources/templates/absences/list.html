<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Absences de <span th:text="${etudiant.nom + ' ' + etudiant.prenom}"></span></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .table-absences th { background-color: #f8f9fa; }
        .badge-justifiee { font-size: 0.9em; }
    </style>
</head>
<body class="bg-light">

<div class="container mt-5">
    <div class="card shadow">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h3>
                Absences de
                <strong th:text="${etudiant.nom + ' ' + etudiant.prenom}"></strong>
                - <span th:text="${etudiant.classe?.libelle}"></span>
            </h3>
            <a th:href="@{/etudiants}" class="btn btn-light">Retour aux étudiants</a>
        </div>

        <div class="card-body">

            <!-- Formulaire d'ajout / modification -->
            <div class="bg-white p-4 rounded border mb-4">
                <h5 class="text-success mb-3">
                    <span th:text="${nouvelleAbsence.id == null} ? 'Ajouter une absence' : 'Modifier l\'absence'"></span>
                </h5>
                <form th:action="@{/absences/save}" method="post">

                    <input type="hidden" name="id" th:value="${nouvelleAbsence?.id}" />
                    <input type="hidden" name="etudiantId" th:value="${etudiant.id}" />

                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Date <span class="text-danger">*</span></label>
                            <input type="date" name="dateAbsence" class="form-control" required
                                   th:value="${nouvelleAbsence?.dateAbsence ?: #temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}" />
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Heure début (retard)</label>
                            <input type="time" name="heuredubet" class="form-control"
                                   th:value="${nouvelleAbsence?.heureDebut}" />
                            <small class="text-muted">Laisser vide si présent le matin</small>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Heure fin (sortie)</label>
                            <input type="time" name="heurefin" class="form-control"
                                   th:value="${nouvelleAbsence?.heureFin}" />
                            <small class="text-muted">Laisser vide si présent l'après-midi</small>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Justifiée ?</label>
                            <div class="mt-2">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="justifiee" value="true"
                                           th:checked="${nouvelleAbsence?.justifiee}">
                                    <label class="form-check-label text-success fw-bold">Oui</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="justifiee" value="false"
                                           th:checked="${nouvelleAbsence == null or !nouvelleAbsence.justifiee}">
                                    <label class="form-check-label text-danger fw-bold">Non</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="form-label">Motif (facultatif si justifiée)</label>
                        <textarea name="motif" class="form-control" rows="2"
                                  th:text="${nouvelleAbsence?.motif}" placeholder="Ex: Certificat médical, maladie..."></textarea>
                    </div>

                    <div class="mt-3">
                        <button type="submit" class="btn btn-success btn-lg">
                            <span th:text="${nouvelleAbsence?.id == null} ? 'Ajouter l\'absence' : 'Enregistrer les modifications'"></span>
                        </button>
                        <a th:href="@{'/absences/etudiant/' + ${etudiant.id}}" class="btn btn-secondary">Annuler</a>
                    </div>
                </form>
            </div>

            <!-- Liste des absences -->
            <h4 class="mt-5 mb-3">Historique des absences</h4>

            <div th:if="${absences.isEmpty()}" class="alert alert-success text-center">
                Aucune absence enregistrée. Bravo !
            </div>

            <table class="table table-hover table-absences" th:unless="${absences.isEmpty()}">
                <thead>
                <tr>
                    <th>Date</th>
                    <th>Heure début</th>
                    <th>Heure fin</th>
                    <th>Justifiée</th>
                    <th>Motif</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="a : ${absences}"
                    th:class="${a.justifiee} ? 'table-success' : 'table-danger'">
                    <td th:text="${#temporals.format(a.dateAbsence, 'dd/MM/yyyy')}"></td>
                    <td th:text="${a.heureDebut != null ? #temporals.format(a.heureDebut, 'HH:mm') : '-'}"></td>
                    <td th:text="${a.heureFin != null ? #temporals.format(a.heureFin, 'HH:mm') : '-'}"></td>
                    <td>
                            <span class="badge badge-justifiee"
                                  th:class="${a.justifiee} ? 'bg-success' : 'bg-danger'"
                                  th:text="${a.justifiee} ? 'Oui' : 'Non'"></span>
                    </td>
                    <td th:text="${a.motif ?: '-'}"></td>
                    <td>
                        <a th:href="@{'/absences/' + ${a.id} + '/delete'}"
                           onclick="return confirm('Supprimer cette absence ?')"
                           class="btn btn-danger btn-sm">Supprimer</a>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="card-footer text-center">
            <small class="text-muted">
                Total absences : <strong th:text="${absences.size()}"></strong> |
                Justifiées : <strong th:text="${absences.?[justifiee == true].size()}"></strong> |
                Non justifiées : <strong th:text="${absences.?[justifiee == false].size()}"></strong>
            </small>
        </div>
    </div>

    <div class="text-center mt-4">
        <a th:href="@{/}" class="btn btn-outline-primary">Accueil</a>
    </div>
</div>

</body>
</html>